ERROR DETALLADO: CIERRE DE CAJA CON ALCANCE INCONSISTENTE
Fecha: 2026-02-17

RESUMEN
- El modulo de caja funciona, pero existe una inconsistencia entre lo que ve el empleador en frontend y lo que cierra realmente el backend.
- Frontend (empleador): muestra resumen global del kiosco (todas las ventas del dia).
- Backend (closeCashbox): cierra solo ventas del usuario autenticado (usuarioUid == uid).

COMPORTAMIENTO ACTUAL
1) Un empleador abre la vista de caja.
2) El resumen en pantalla incluye ventas de todo el kiosco.
3) Al confirmar cierre, la funcion backend filtra por usuarioUid del token.
4) El cierre generado puede incluir solo una parte de las ventas visibles.

CAUSA TECNICA
- En backend, closeCashbox consulta ventas pendientes con filtro estricto por usuario:
  where("cajaId", "==", null)
  where("usuarioUid", "==", uid)
- En frontend, para rol empleador, la lectura de resumen usa alcance global del kiosco.
- Resultado: distintas reglas de alcance entre lectura (frontend) y cierre efectivo (backend).

IMPACTO
- Diferencia entre monto visualizado y monto realmente cerrado.
- Riesgo operativo y contable: percepcion de "faltantes" o "sobrantes" en cierre.
- Riesgo de auditoria: no coincide lo informado en UI con lo persistido en caja.

COMO REPRODUCIR
Precondiciones:
- Tenant con al menos 2 usuarios (empleador + empleado).
- Ventas pendientes del dia creadas por ambos usuarios.

Pasos:
1) Iniciar sesion como empleador.
2) Abrir pantalla de caja y observar total diario (vista global).
3) Ejecutar "cerrar caja".
4) Revisar documento de caja generado y lista ventasIncluidas.

Resultado observado:
- El total cerrado puede no coincidir con el total mostrado en la vista global.
- ventasIncluidas puede excluir ventas de otros usuarios del tenant.

CRITERIO DE CORRECCION
- Debe existir una sola regla de alcance para resumen y cierre.
- Si el empleador tiene cierre global:
  - Backend debe cerrar todas las ventas pendientes del tenant (sin filtrar por usuarioUid), o
  - usar una condicion por rol para alcance global del empleador.
- Si no se permite cierre global:
  - Frontend debe mostrar solo "tus ventas" tambien para empleador al momento de cerrar.

RECOMENDACION
- Definir politica explicita:
  A) Empleador cierra global; empleado cierra solo sus ventas.
  B) Ambos cierran solo sus ventas.
- Implementar la misma politica en:
  - Consulta de resumen (frontend).
  - Consulta de cierre (backend).
  - Mensajeria de UI (etiqueta de alcance visible antes de confirmar cierre).

PRUEBAS MINIMAS DESPUES DEL FIX
1) Empleador con ventas de varios usuarios: total mostrado == total cerrado.
2) Empleado: solo ve y cierra sus ventas.
3) Sin ventas pendientes del alcance seleccionado: mensaje correcto de precondicion.
4) Reintento de cierre del mismo turno: no duplicar cierres.

